{% extends 'base.html' %}
{% load crispy_forms_tags %}
{% load static %}

{% block title %}Book a Session{% endblock %}

{% block content %}
<div class="center-box">
    <h2 class="text-center mb-4">{% if is_edit %}Edit Session{% else %}Book a Session{% endif %}</h2>
    {% if user.profile.is_coach %}
        <div class="alert alert-info text-center mb-0">
            <i class="fas fa-info-circle me-2"></i>
            As a coach, you cannot book sessions. You can only receive bookings from clients.
        </div>
    {% endif %}
    <form method="post" enctype="multipart/form-data" id="booking-form">
        {% csrf_token %}
        <div class="mb-3">
            <label for="id_service" class="form-label">Service*</label>
            <select id="id_service" name="service" class="form-control">
                <option value="">---------</option>
                {% for service in services %}
                    <option value="{{ service.pk }}"
                            data-price="{{ service.price }}"
                            data-duration="{{ service.duration }}"
                            data-description="{{ service.description }}"
                            {% if form.initial.service|stringformat:"s" == service.pk|stringformat:"s" %}selected{% endif %}>
                        {{ service.name }}
                    </option>
                {% endfor %}
            </select>
        </div>
        <h5 class="card-title">Service Details</h5>
        <div class="mb-3">
            <label for="id_price" class="form-label">Price</label>
            <input type="text" id="id_price" class="form-control" readonly value="{{ form.initial.price }}">
        </div>
        <div class="mb-3">
            <label for="id_duration" class="form-label">Duration (minutes)</label>
            <input type="text" id="id_duration" class="form-control" readonly value="{{ form.initial.duration }}">
        </div>
        <div class="mb-3">
            <label for="id_description" class="form-label">Description</label>
            <textarea id="id_description" class="form-control" rows="3" readonly>{{ form.initial.description }}</textarea>
        </div>
        {{ form.date_time|as_crispy_field }}
        {{ form.type|as_crispy_field }}
        {{ form.notes|as_crispy_field }}
        <div id="online-fields" style="display: none;">
            {{ form.meeting_url|as_crispy_field }}
        </div>
        <div id="personal-fields" style="display: none;">
            {{ form.meeting_address|as_crispy_field }}
        </div>
        {{ form.payment_method|as_crispy_field }}
        <div class="form-actions">
            <button type="submit" class="get-started-btn">{% if is_edit %}Save Changes{% else %}Book Session{% endif %}</button>
            <a href="{% url 'viewer:session_history' %}" class="get-started-btn" style="background: #7a868a;">Cancel</a>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
const servicesData = {{ services_json|safe }};
const serviceSelect = document.getElementById('id_service');
const priceInput = document.getElementById('id_price');
const durationInput = document.getElementById('id_duration');
const descriptionInput = document.getElementById('id_description');
const typeSelect = document.getElementById('id_type');
const onlineFields = document.getElementById('online-fields');
const personalFields = document.getElementById('personal-fields');

function updateServiceInfo() {
    const selectedId = serviceSelect.value;
    if (selectedId && servicesData[selectedId]) {
        priceInput.value = servicesData[selectedId].price;
        durationInput.value = servicesData[selectedId].duration;
        descriptionInput.value = servicesData[selectedId].description;
    } else {
        priceInput.value = '';
        durationInput.value = '';
        descriptionInput.value = '';
    }
}

function updateMeetingFields() {
    const type = typeSelect.value;
    if (type === 'online') {
        onlineFields.style.display = 'block';
        personalFields.style.display = 'none';
    } else if (type === 'personal') {
        onlineFields.style.display = 'none';
        personalFields.style.display = 'block';
    } else {
        onlineFields.style.display = 'none';
        personalFields.style.display = 'none';
    }
}

if (serviceSelect) {
    serviceSelect.addEventListener('change', function() {
        const url = new URL(window.location.href);
        url.searchParams.set('service', this.value);
        window.location.href = url.toString();
    });
    updateServiceInfo();
}

if (typeSelect) {
    typeSelect.addEventListener('change', updateMeetingFields);
    updateMeetingFields();
}
</script>
{% endblock %}
